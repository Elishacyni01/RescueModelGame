PImage []thsr;
PImage thsr0,thsr1,thsr2,thsr3;
PImage hand, stone, salesman, motor, road, life, lifeHalf;
PImage gamestart, gamerun1, gamerun2, gamewin, gamelosetime, gamelosebroken;
PImage restartHovered, restartNormal, startHovered, startNormal, row, sky;
PImage [][] playerImage;
// PImage [] playerIdle, playerMotor, playerCrash;

PImage playerCrash, playerIdle;
PFont font;

final int GAME_START = 0, GAME_RUN1 = 1, GAME_RUN2 = 2, GAME_WIN = 3, GAME_LOSE_TIME = 4, GAME_LOSE_BROKEN = 5;
int gameState = 2;

final int START_BUTTON_WIDTH = 200;
final int START_BUTTON_HEIGHT = 100;
final int START_BUTTON_X = 350;
final int START_BUTTON_Y = 300;
final int RESTART_BUTTON_X = 200;
final int RESTART_BUTTON_Y = 350;


final int PLAYER_RUN_POSE = 2;
final int PLAYER_STATUS = 3;
int playerRow;

final int BAR_HEIGHT = 60;
int barWidth = 60;

float roadSpeed = 0;

final int GAME_INIT_TIMER = 7200;
int gameTimer = GAME_INIT_TIMER;
final float CLOCK_BONUS_SECONDS = 15f;

boolean rightState = false;
boolean upState = false;
boolean downState = false;

Player player;

void setup() {
  size(640, 480, P2D);
  
  hand = loadImage("img/hand.jpg");
  stone = loadImage("img/stone.jpg");
  salesman = loadImage("img/salesman.jpg");
  motor = loadImage("img/motor.jpg");
  gamestart = loadImage("img/gamestart.jpg");
  gamerun1 = loadImage("img/gamerun1.jpg");
  gamewin = loadImage("img/gamewin.jpg");
  gamelosetime = loadImage("img/gamelosetime.jpg");
  gamelosebroken = loadImage("img/gamelosebroken.jpg");
  restartHovered = loadImage("img/restartHovered.png");
  restartNormal = loadImage("img/restartNormal.png");
  startHovered = loadImage("img/startHovered.png");
  startNormal = loadImage("img/startNormal.png");
  row = loadImage("img/row.png");
  sky = loadImage("img/sky.jpg");
  road = loadImage("img/road.png");
  life = loadImage("img/life.png");
  lifeHalf = loadImage("img/lifeHalf.png");
  playerIdle = loadImage("img/players/playerIdle.png");
  
  font = createFont("font/font.ttf", 56);
  textFont(font);


  // Load PImage[][] player
  playerImage = new PImage[PLAYER_STATUS][PLAYER_RUN_POSE];
  for(int i = 0; i < playerImage.length; i++){
    for(int j = 0; j < playerImage[i].length; j++){
      playerImage[i][j] = loadImage("img/players/player" + i + "_" + j + ".png");
    }
  }
  
  
  thsr0 = loadImage("img/thsr0.jpg");
  thsr1 = loadImage("img/thsr1.jpg");
  thsr2 = loadImage("img/thsr2.jpg");
  thsr3 = loadImage("img/thsr3.jpg");
  
  initGame();

}

void initGame(){
  // Initialize Game
  player = new Player();
  gameTimer = GAME_INIT_TIMER;
}

<<<<<<< HEAD
=======

>>>>>>> f25c8e38730eb85bf18d0b01143ac07ef5eaa6f9
void draw() {
  
  switch (gameState) {

    case GAME_START:
      image(gamestart, 0, 0);
      
      if(START_BUTTON_X + START_BUTTON_WIDTH > mouseX
        && START_BUTTON_X < mouseX
        && START_BUTTON_Y + START_BUTTON_HEIGHT > mouseY
        && START_BUTTON_Y < mouseY) {
  
        image(startHovered, START_BUTTON_X, START_BUTTON_Y);
        if(mousePressed){
          gameState = GAME_RUN1;
          mousePressed = false;
        }
  
      }else{
  
        image(startNormal, START_BUTTON_X, START_BUTTON_Y);
  
      }
    
    break;
        
    case GAME_RUN1:  // Rubbing model
    
      image(gamerun1, 0, 0);
      
      if(barWidth <= 200){
      image(thsr0, 100, 150);
      }
      if(barWidth <= 450 && barWidth > 200){
      image(thsr1, 100, 150);
      }
      if(barWidth <= 600 && barWidth > 450){
      image(thsr2, 100, 150);
      }
      if(barWidth <= 640 && barWidth > 600){
      image(thsr3, 100, 150);
      }
      
      noCursor();
      
      // Restrict hand area
      
      if(mouseX < 170){
        mouseX = 170;
      }else if(mouseX > 520){
        mouseX= 520;
      }
      if(mouseY < 220){
        mouseY = 220;
      }else if(mouseY > 420){
        mouseY= 420;
      }
      
      image(hand, mouseX - 120 , mouseY - 120);
      
      // Bar
      fill(#FFFF00);
      strokeWeight(3);
      stroke(#4d3900);
      rect(5, 420, barWidth, BAR_HEIGHT, 7);
      
      // Bar Progress
      if(barWidth > width - 10){
        gameState = GAME_RUN2;
      }
      
      // Timer

    gameTimer --;
    if(gameTimer <= 0) gameState = GAME_LOSE_TIME;
    drawTimerUI();
    
    break;
    
    

    case GAME_RUN2: // Start run
    
      // Background
      image(sky, 0, 0);
      image(row, 0, 0);
      
      for(int i=0; i < 15; i++){
        for(int j=0; j < 3; j++){
          image(road, roadSpeed + i * 100, 180 + j*100);
        }
      }
      
      // Player
      

      player.update();

    // Timer
    gameTimer --;
    if(gameTimer <= 0) gameState = GAME_LOSE_TIME;
    drawTimerUI();  
    
    break;

    case GAME_WIN: 
      image(gamewin, 0, 0);
      restart();
      initGame();
    break;
        
    case GAME_LOSE_TIME: // time over
      image(gamelosetime, 0, 0);
      restart();
      initGame();
    break;
        
    case GAME_LOSE_BROKEN: //model broken
      image(gamelosebroken, 0, 0);
      restart();
      initGame();
    break;
  }
}

void restart(){
  if(RESTART_BUTTON_X + START_BUTTON_WIDTH > mouseX
      && RESTART_BUTTON_X < mouseX
      && RESTART_BUTTON_Y + START_BUTTON_HEIGHT > mouseY
      && RESTART_BUTTON_Y < mouseY) {

      image(restartHovered, RESTART_BUTTON_X, RESTART_BUTTON_Y);
      if(mousePressed){
        gameState = GAME_START;
        mousePressed = false;
      }

    }else{

      image(restartNormal, RESTART_BUTTON_X, RESTART_BUTTON_Y);

    }
}

boolean isHit(float ax, float ay, float aw, float ah, float bx, float by, float bw, float bh){
  return  ax + aw > bx &&    // a right edge past b left
        ax < bx + bw &&    // a left edge past b right
        ay + ah > by &&    // a top edge past b bottom
        ay < by + bh;
}

//mm:ss format
void drawTimerUI(){
  textSize(56);
  String timeString = convertFramesToTimeString(gameTimer);
  textAlign(RIGHT, TOP);
  
  // Time Text Shadow Effect
  fill(0, 120);
  text(timeString, 623, 3);
  
  // Actual Time Text
  color timeTextColor = getTimeTextColor(gameTimer);
  fill(timeTextColor);
  text(timeString, 620, 0);
}

void addTime(float seconds){
  gameTimer += seconds * 4 * 15;          
}

String convertFramesToTimeString(int frames){
  String mm=nf(floor(floor(frames/60)/60),2);
  String ss=nf(floor(frames/60)%60,2);
  return mm+":"+ss;  
}

color getTimeTextColor(int frames){  
  int min = floor(frames / (60 * 60));
  int sec = (floor(frames / 60)) % 60;
  
  if(min >= 2){return #00ffff;
  }else if(min == 1){return #000000;
  }else if(min == 0 && sec <= 59 && sec >= 30){return #ffcc00;
  }else if(min == 0 && sec <= 29 && sec >= 10){return #ff6600;
  }else {return #000000;} 
  
}

  
void keyPressed(){
  if(key==CODED){
    switch(keyCode){
      case RIGHT:
      rightState = true;
      break;
      case UP:
      upState = true;
      break;
      case DOWN:
      downState = true;
      break;
    }
  }else{
    if(key=='t'){
      gameTimer -= 180;
    }
}
}

void keyReleased(){
  if(key==CODED){
    switch(keyCode){
      case RIGHT:
      rightState = false;
      break;
      case UP:
      upState = false;
      break;
      case DOWN:
      downState = false;
      break;
    }
  }
}
